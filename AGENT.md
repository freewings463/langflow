# 架构迁移注释规范（可执行版）

> 顶尖注释不是"解释代码"，而是**传递代码无法自证的信息**。目标是让读者在 3–5 分钟内做出正确修改与排障决策，而不是"看懂每一行"。

## 强制执行承诺

所有参与迁移的开发者必须承诺：

1. **不写废话**：如果注释能被代码直接推断出来，立即删除。  
2. **必须具体**：禁止"处理/优化/确保/提升"等空话；用数字、场景、范围替代。  
3. **风险透明**：公开披露已知失败模式，并给出缓解与观测入口。  
4. **持续维护**：改代码必须同步更新注释或删除过时注释。

违反承诺的后果（评审/CI 执行）：
- 第一次：退回并要求按本规范逐条修复
- 第二次：暂停迁移合并权限，参加注释评审培训
- 第三次：退出迁移批次

签署（可选）：_______________（姓名）  _______________（日期）

## 核心原则（最高优先级）

## 注释风格（必须一致）

为避免"数量多但关键点缺失 / 风格混乱"的问题，注释必须满足以下风格约束：

1. **语言统一为中文**：允许引用标识符、日志关键字、协议字段、配置名等，用反引号包裹（例如 `async_start` / `logs` / `Failed to load graph`）。  
2. **禁止表情符号标签**：不使用任何 emoji 作为注释前缀，统一用中文关键词。  
3. **统一前缀**（按需使用）：`决策：` / `注意：` / `实现：` / `排障：` / `安全：` / `性能：`  
4. **避免"贴着一行代码解释一行代码"**：不要为变量声明/显而易见的 if/for 写注释；把"为什么/代价/陷阱"写在对应的逻辑块上方。  
   - ❌ `# 将 JSON 解析为 dict` + `flow_dict: dict | None = None`  
   - ✅ 在解析分支前说明"为何不走临时文件、异常语义是什么、边界是什么"

### 0) 模块级概述注释（新增）

对于复杂模块，应在文件顶部添加模块级概述性注释，说明该模块在整个系统中的作用、主要功能和设计目的，帮助开发者快速理解代码上下文。

```python
"""
模块名称：[模块功能概述]

本模块提供[具体功能描述]，主要用于[使用场景]。主要功能包括：
- 功能1：[详细描述]
- 功能2：[详细描述]
- 功能3：[详细描述]

关键组件：
- 类/函数A：[作用描述]
- 类/函数B：[作用描述]
- 类/函数C：[作用描述]

设计背景：[为什么需要这个模块，解决了什么问题]
注意事项：[使用本模块时需要注意的关键点]
"""
```

### 1) 只写五类代码无法自证的信息（强制记忆清单）

**删除测试**：如果代码一眼就能看出来，就别写。每行注释必须属于以下五类之一，否则删除。

1. **历史决策**：为什么选这个方案？替代方案是什么？妥协原因？（优先给 ADR/RFC/Issue 链接）
   - ❌ "使用哈希表实现缓存"
   - ✅ "选择 Redis 而非 Memcached：需要数据结构与持久化（ADR-003）"

2. **失败语义**：会出什么问题？失败时返回什么？调用方如何应对？
   - ❌ "可能失败"
   - ✅ "网络超时 30s 抛 `TimeoutError`；调用方重试 2 次后降级"

3. **契约边界**：隐式约束/上限/安全边界（性能、并发、资源、权限、兼容性）
   - ❌ "处理大量数据"
   - ✅ "支持 `QPS<=500`、内存上限 1GB、单请求超时 5s"

4. **迁移上下文**：从哪里来？为什么在这里？需要满足哪些兼容要求？
   - ❌ "迁移过来的代码"
   - ✅ "原位于 `src/lfx/run/`，因职责是 Langflow SDK 适配器，迁至 Infrastructure 层"

5. **可观测点**：如何排障？关键日志/指标/追踪入口是什么？
   - ❌ "记录日志"
   - ✅ "组件执行超时时打 WARN（关键字 `timeout`），指标 `component_timeout_total` +1"

### 2) 设计决策必须包含四要素（缺一不可）

每个"决策类注释"必须回答四个问题（否则视为无效注释）：

```text
# 决策：<具体决策>
# 问题：<要解决的具体问题>
# 方案：<选择的方案，为什么>
# 代价：<付出的代价/妥协>
# 重评：<何时需要重新评估>
```

示例：

```python
# 决策：同步 HTTP 客户端而非异步
# 问题：异步客户端引入复杂性，团队当前不熟悉 asyncio
# 方案：使用 requests（同步），简化错误处理并与现有风格一致
# 代价：阻塞线程，并发上限约 500 QPS
# 重评：当 QPS>300 或 I/O 密集增长时评估迁移到 httpx
```

### 3) 把注释写成"接口契约"（Contract）

类/函数级注释必须明确：
- **输入/输出**：类型、约束、默认值、返回结构
- **副作用**：I/O、全局状态、缓存、外部系统调用
- **失败语义**：异常/错误码/默认值/部分成功，以及调用方应对方式

### 4) 复杂函数用"三步导航法"（≤5 行主干）

对复杂函数（经验阈值：>15 行 或 有非显然分支/资源释放/并发/序列化/权限）必须在开头提供导航：

```python
def complex_function():
    """一句话业务价值

    关键路径（三步）：
    1) <输入验证/预处理>
    2) <核心处理（关键分支）>
    3) <结果组装/清理>

    异常流：<列 2-3 个最常见/最关键的异常与处理方式>
    性能瓶颈：<最可能慢的点>
    排障入口：<日志关键字/指标/追踪入口>
    """
```

### 5) 强制高信息密度（Signal Density）

三秒测试：删掉这行注释会让读者更难做决策/更容易误用/更难排障吗？如果不会，删掉。

### 6) 可追溯、可维护（Traceable & Maintained）

能链接就不长篇：用 `decision_records` 指向 ADR/RFC/Issue。修改代码必须同步更新或删除注释；过时注释比无注释更危险。

## 三层注释结构（必须遵守）

1) **模块级概述注释（文件顶部）**：回答"这是什么、有什么用、如何使用"
- 必须包含：**模块目的**、**主要功能**、**设计背景**、**使用场景**、**关键组件概览**
- 每个文件都应有此注释（特别是 >200 行或 >5 个函数/类的文件）

2) **业务接口注释（类/函数级）**：回答"做什么、为谁服务、失败怎么办"
- 必须包含：**契约**、**关键路径/导航**、**设计决策（含代价与重评条件）**
- 公共类/公共方法/复杂函数必须写；私有且显然的函数可省略或一行意图

3) **实现警示（复杂代码块前）**：只标记真正复杂或高风险的代码块（经验阈值：>5 行或包含非显然分支/资源释放/并发/序列化/权限）
- 标签：风险 / 决策 / 排障 / 测试 / 安全 / 性能 / 注意

## 长度预算（防止啰嗦）

- 模块级概述：**≤ 20 行**，简洁明了描述模块作用。
- 公共函数 docstring：**≤ 12 行**；复杂函数允许"三步导航法"额外 **≤ 8 行**。  
- 行内注释：**≤ 2 行**，且必须是"五类不可自证信息"。  

## 注释精简检查表（提交前逐条核对）

### ✅ 必须删除的（立即拒绝）

1. [ ] **代码翻译**：删除所有解释"代码在做什么"的注释  
   - ❌ `# 循环遍历列表`（代码已有 `for item in items:`）

2. [ ] **重复签名**：删除重复函数签名的说明  
   - ❌ `"""参数 x 是输入，返回 y"""`（签名已有 `def func(x) -> y:`）
   - ✅ 改为：`"""将输入 x 转换为 y，并处理边界 a/b"""`

3. [ ] **抽象空话**：删除"处理数据/业务逻辑/优化性能/提高效率"等无信息密度词  
   - ✅ 用数字/场景替代：`查询 200ms->20ms`

4. [ ] **风格混乱**：删除/修正不一致格式  
   - ❌ 使用表情符号标签（任何 emoji 前缀）  
   - ❌ 中英文句子混写（允许 `...` 包裹标识符/日志关键字/字段名）  
   - ✅ 统一使用 `决策：/注意：/实现：/排障：/安全：/性能：` 前缀

### ✅ 必须简化的（压缩 50%）

5. [ ] **过度详细**：超过 3 句的解释压缩为 1 句 + 数字/边界  
6. [ ] **技术散文**：小作文改为要点列表（只保留决策、边界、失败语义、排障入口）

### ✅ 必须具体的（添加数字/示例）

7. [ ] **量化描述**：形容词替换为数字（超时/重试/QPS/内存/成本）  
8. [ ] **示例场景**：每个 `business_problem` 必须有具体 `use_case`

## 差异化检查：相似度 <30%（机械执行）

规则：同一文件中不同方法注释的"自由文本"相似度必须 <30%（模板标题不计）；若两段注释互换仍合理，说明信息不够独有。

检查方法（可人工/可脚本）：
1. 提取自由文本：去掉固定标题（如"契约：/关键路径：/异常流："）
2. 比较相似度：简单词频/语义相似度均可
3. 低于阈值：相似度 >=30% 退回

强制独特信息：每个方法注释必须包含至少一个该方法独有的：具体依赖/配置值/失败模式/业务约束/指标或日志关键字。

（可选自动化）若后续实现脚本，可提供类似：`python scripts/check_comment_uniqueness.py --max-similarity 0.3`

## 风险披露原则（失败语义必须明确）

- 可能出什么问题（触发条件/边界）？  
- 失败时返回什么（异常/错误码/默认值/部分成功）？  
- 调用方应如何应对（重试/降级/提示/回滚）？  
- 如何监控与告警（日志关键字/指标/阈值/追踪入口）？

## 强制执行门禁（评审/CI）

- **立即拒绝**：
  - 出现"处理数据/业务逻辑/显然/优化性能/提高效率"等空话
  - 公共类/公共方法注释覆盖率 <100%
  - 复杂函数未提供"三步导航法"
  - 决策类注释缺少"决策四要素"
  - 使用表情符号标签或中英文句子混写导致风格不一致
  - 缺少模块级概述注释（对于 >200 行或 >5 个函数/类的文件）

- **质量评分**（按文件/模块）：A（≥85）通过；B（70–84）限期修复；C（<70）暂停迁移。

## 注释质量评分卡（每个文件建议提交）

评分维度（每项 0–10）：
| 维度 | 评分标准 | 检查方法 |
|------|----------|----------|
| 模块概述 | 模块目的和功能清晰 | 是否能快速理解模块用途 |
| 信息密度 | 无废话，每行都有新信息 | 随机删一行，看是否影响决策 |
| 具体性 | 有数字/场景/范围 | 查是否出现空话词 |
| 契约完整性 | 输入/输出/副作用/失败语义明确 | 逐项核对 |
| 风险披露 | 风险+缓解+观测入口 | 看实现警示 |
| 差异化 | 相似度<30% | 人工/脚本检查 |
| 可追溯性 | 有决策记录链接 | 查 `decision_records` |
| 可维护性 | 注释与代码同步 | 改动时同步更新 |

等级：A（85–100）/ B（70–84）/ C（<70）。

（可选自动化）若后续实现脚本，可提供类似：`python scripts/score_comments.py --file <path> --output scorecard.yaml`

## 复杂度匹配（注释与代码复杂度同频）

- **简单代码（<3 行）**：一行或无注释（除非涉及契约/边界/风险）。  
- **中等代码（3–10 行）**：简要意图 + 1–2 个关键点（边界/失败/副作用）。  
- **复杂代码（>10 行）**：完整契约 + 三步导航 + 风险披露 + 排障入口。

## 最终检验（3 分钟）

删掉注释后，读者是否仍能在 3 分钟内回答：
1) 这段代码为什么在这里（迁移上下文/决策）？  
2) 它解决什么具体问题（use_case/value_metric）？  
3) 可能出什么问题，如何应对/如何排障（失败语义/观测入口）？